<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Find products in retail stores">
    <meta name="author" content="Aram Baghdassarian and Ben Newman">
    <link rel="../static/img/apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="../static/img/apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="../static/img/apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="../static/img/apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="../static/img/apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="../static/img/apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="../static/img/apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="../static/img/apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="../static/img/apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="../static/img/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../static/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../static/img/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../static/img/favicon-16x16.png">
    <link rel="manifest" href="../static/img/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="../static/img/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <title>Results</title>

    <!-- Bootstrap Core CSS -->
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/grayscale.css') }}" rel="stylesheet">

    <!-- jQuery -->
    <script src="{{ url_for('static', filename='js/jquery.js') }}"></script>

    <!--JQuery UI -->
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

    <!-- Custom Material Design Library -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.indigo-red.min.css" />
    <script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>

    <!-- Custom Fonts -->
    <link href="{{ url_for('static', filename='font-awesome/css/font-awesome.min.css') }}" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">



    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
        .demo-card-event.mdl-card {
            width: 256px;
            height: 256px;
            background: #3E4EB8;
        }
        .demo-card-event > .mdl-card__actions {
            border-color: rgba(255, 255, 255, 0.2);
        }
        .demo-card-event > .mdl-card__title {
            align-items: flex-start;
        }
        .demo-card-event > .mdl-card__title > h4 {
            margin-top: 0;
        }
        .demo-card-event > .mdl-card__actions {
            display: flex;
            box-sizing:border-box;
            align-items: center;
        }
        .demo-card-event > .mdl-card__actions > .material-icons {
            padding-right: 10px;
        }
        .demo-card-event > .mdl-card__title,
        .demo-card-event > .mdl-card__actions,
        .demo-card-event > .mdl-card__actions > .mdl-button {
            color: #fff;
        }
        #page-top {
            color: gray;
        }
        .demo-card-wide.mdl-card {
            width: 1140px;
            margin: auto;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        .demo-card-wide > .mdl-card__title {
            color: #fff;
            /*height: 176px;*/
        }
        .demo-card-wide > .mdl-card__menu {
            color: #fff;
        }
        .storeResult {
            cursor: pointer;
        }
        .storeName {
            color: #2f3aff;
            margin-left:10px;
            margin-top:2px;
            font-weight: 600;
        }
        .storeAddress {
            margin-left:8px;
            padding-left: 0px;
            padding-top: 5px;
        }
        .storePrice{
            padding-top: 0px;
            font-size: 11px;
            color: green;
            margin-left: 10px;
        }
        .distance {
            padding-left: 11px;
            padding-bottom: 0;
            padding-top: 10px;
        }
        .searchTitle {
        	color: #fff;
        	margin-top:150px;
        	font-size:300%;
        	text-align: center;
        	font-weight: bold;
        }

    </style>
</head>

<body id="page-top" data-spy="scroll" data-target=".navbar-fixed-top">

<!-- Navigation -->
<nav class="navbar navbar-custom navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-main-collapse">
                <i class="fa fa-bars"></i>
            </button>
            <a class="navbar-brand page-scroll" href="#page-top">
                <i class="glyphicon glyphicon-shopping-cart"></i>  <span class="light">Retail</span> Trail
            </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse navbar-right navbar-main-collapse">
            <ul class="nav navbar-nav">
                <!-- Hidden li included to remove active class from about link when scrolled up past about section -->
                <li class="hidden">
                    <a href="#page-top"></a>
                </li>
                <li>
                    <a href="/index.html">Home</a>
                </li>
                <li>
                    <a href="/addStore.html">Add a store</a>
                </li>
                <li>
                    <a class="page-scroll" href="/index.html#about">About</a>
                </li>
                <!--<li>-->
                <!--<a class="page-scroll" href="#download">Download</a>-->
                <!--</li>-->
                <li>
                    <a class="page-scroll" href="/index.html#contact">Contact</a>
                </li>
                <li>
                    <a><table><tr><td><div id="custom-search-input" style="width:200px;">
                        <div class="col-md-3 input-group" style="width:100%;margin-top:-6px;">
                            <form action="" method="post" id="searchForm">
                                {{ form.hidden_tag() }}
                                {{ form.searchBox(size=25, placeholder="Search for a product", class_="search-query form-control") }}
                                <!--input type="text" class="search-query form-control" id="productSearch" name="prdouctSearch" placeholder="Search for a product" />-->
                            </form>
                        </div>
                    </div>
                    </td>
                        <td>
                            <span class="input-group-btn" style="width: 50px;">
                            <button class="btn btn-danger" form="searchForm" type="submit" style="margin-top:-5px;">
                                <span class=" glyphicon glyphicon-search"></span>
                            </button>
                        </span>
                        </td>
                    </tr>
                    </table>
                    </a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<!-- Title of the Page (search result) -->
<div class="container text-center searchTitle" style="margin-bottom: -200px;">
    <div class="demo-card-event mdl-card mdl-shadow--2dp" style="margin-top: 100px;margin-bottom: -200px;margin:auto;min-height: 50px;width: 1140px;height: 70px;">
        <div class="mdl-card__title" style="width: 132px;margin: auto;">
            <h4>
                {{ search }}
            </h4>
        </div>
    </div>
</div>
<!-- Map Section -->
<section id="mapSec" class="container text-center">
    <div id="map" style="position:fixed;width:1140px;"></div>
    <script>
    $(document).ready(function() {
        var map;
        var geocoder;
        window.initMap = function () {
            geocoder = new google.maps.Geocoder();
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: -34.397, lng: 150.644},
                zoom: 15
            });
            var initialLocation = '';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    map.setCenter(initialLocation);
                    console.log(initialLocation);
                    var infowindow = new google.maps.InfoWindow({
                        content: 'You are here'
                    });
                    var marker = new google.maps.Marker({
                        position: initialLocation,
                        title: "Your location",
                        map: map
                    });
                        infowindow.open(map, marker);


                    // To add the marker to the map, call setMap();
//                marker.setMap(map);
//            var storeMarker = new google.maps.Marker({
//                position: {lat: -33.890, lng: 151.274},
//                map: map,
//                title: "Name of Store",
//                icon: "../static/img/blueMarker.png"
//            });
//            storeMarker.setMap(map);
                    //var streetStores = {{ mapLocs }};
                    //for stores that are not geocoded.
                    // [['CVS', '19 Middle Neck Road, Great Neck, NY 11021'],
                    //['Walmart', '99 Madis Avenue, New York, NY 10016']];

                    //geocode the uncoded stores.
                    //for (var i = 0; i < streetStores.length; i++){
                    var count = 0;
                    {%
                        for loc in mapLocs %}
                    console.log("hello", "{{ loc[2] }}");
                    codeAddress([["{{ loc[0] }}", "{{ loc[1] }}"], count, "{{ loc[2] }}"]);
                    count += 1;
                    {%
                        endfor
                    %}
                    //}
                    function codeAddress(storeInfo) {
                        var address = storeInfo[0][1];
                        var retailName = storeInfo[0][0];
                        var index = storeInfo[1];
                        var retailPrice = storeInfo[2];
                        geocoder.geocode({'address': address}, function (results, status) {
                            if (status == google.maps.GeocoderStatus.OK) {
                                var contentString = '<h4>' + retailName + '</h4>' +
                                                '<div><p>' + address + ' ' + '</p></div>' +
                                                '<p>' + '$' + retailPrice + '</p>';
                                var infowindow = new google.maps.InfoWindow({
                                    content: contentString
                                });
                                var marker = new google.maps.Marker({
                                    map: map,
                                    position: results[0].geometry.location,
                                    animation: google.maps.Animation.DROP,
                                    title: storeInfo[0][0],
                                    icon: '../static/img/blueMarker.png'
                                }); //TODO:  different color markers and corresponding color text, apps
                                marker.addListener('click', function() {
                                    infowindow.open(map, marker);
                                    $('.storeResult').eq(index).effect( "highlight", {color:"#669966"}, 1500 );
                                }); //TODO: Change deodorant, spacing, fixed map
                                $('.storeResult').eq(index).click(function(){
                                    toggleBounce();
                                });
                                function toggleBounce() {
                                    if (marker.getAnimation() !== null) {
                                        marker.setAnimation(null);
                                    } else {
                                        marker.setAnimation(google.maps.Animation.BOUNCE);
                                        setTimeout(function(){ marker.setAnimation(null); }, 1470);
                                    }
                                }

                                var service = new google.maps.DistanceMatrixService();
                                service.getDistanceMatrix(
                                        {
                                            origins: [initialLocation],
                                            destinations: [storeInfo[0][1]],
                                            travelMode: google.maps.TravelMode.WALKING,
//                                            drivingOptions: google.maps.TravelMode.DRIVING,
                                            unitSystem: google.maps.UnitSystem.IMPERIAL,
                                            avoidHighways: false,
                                            avoidTolls: false
                                        }, callback);

                                function callback(response, status) {
                                    if (status == google.maps.DistanceMatrixStatus.OK) {
                                        var origins = response.originAddresses;
                                        var destinations = response.destinationAddresses;
                                        for (var i = 0; i < origins.length; i++) {
                                            var results = response.rows[i].elements;
                                            for (var j = 0; j < results.length; j++) {
                                                var element = results[j];
                                                var distance = element.distance.text;
                                                $('.distance').eq(index).text(distance);
                                                var duration = element.duration.text;
                                                var from = origins[i];
                                                var to = destinations[j];
                                            }
                                        }
                                    }
                                }
                            } else {
                                alert("Geocode was not successful for the following reason: " + status);
                            }
                        });
                    }


//            var stores = [
//                ['CVS', -33.890542, 151.274856],
//                ['Walmart', -33.923036, 151.259052],
//                ['7/11', -34.028249, 151.157507],
//                ['Rite Aid', -33.80010128657071, 151.28747820854187],
//                ['Walgreens', -33.950198, 151.259302]
//            ];
//            for (var i = 0; i < stores.length; i++) {
//                var store = stores[i];
//                var marker = new google.maps.Marker({
//                    position: {lat: store[1], lng: store[2]},
//                    map: map,
//                    icon: "../static/img/blueMarker.png",
//                    title: store[0]
//                });
//            }
                });
            }//
        }
    });
    </script>
</section>
<!--Slider for max distance-->
<div>
{{ formSlider.distanceSlider(class_="mdl-slider mdl-js-slider",min="0", max="100", value="25", tabindex="0") }}
</div>
<!--Post each individual result-->
{% if mapLocs|length == 0 %}
		<div class="demo-card-wide mdl-card mdl-shadow--2dp storeResult" style="min-height:100px;">
    	<span class="storeName">No Stores Available</span>
    	<span class="mdl-card__supporting-text distance">
    	    If you sell this product please click on 'ADD A STORE'
    	</span>
    	<div class="mdl-card__supporting-text storeAddress">
        	Hopefully we will support this product shortly
    	</div>
    </div>
{% else %}
	{% for loc in mapLocs %}
		{% include 'store.html' %}
	{% endfor %}
{% endif %}

<!-- Footer -->
<footer>
    <div class="container text-center">
        <p>Copyright &copy; Retail Trail 2016</p>
    </div>
</footer>

<!-- Bootstrap Core JavaScript -->
<script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>

<!-- Plugin JavaScript -->
<script src="{{ url_for('static', filename='js/jquery.easing.min.js') }}"></script>

<!-- Google Maps API Key - Use your own API key to enable the map feature. More information on the Google Maps API can be found at https://developers.google.com/maps/ -->
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCRngKslUGJTlibkQ3FkfTxj3Xss1UlZDA&sensor=false"></script>

<!-- Custom Theme JavaScript -->
<script src="{{ url_for('static', filename='js/grayscale.js') }}"></script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1tP3TVYgejPgqe8vw-JmuFkgOyl5b5gc&callback=initMap" async defer></script>

</body>

</html>
